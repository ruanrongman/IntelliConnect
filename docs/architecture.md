# 系统架构

## 整体架构概览

IntelliConnect 是一个基于 Agent 智能体设计的物联网平台内核，采用分层架构设计，主要包括以下几个核心层次：

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI)                        │
├─────────────────────────────────────────────────────────┤
│                    API 接口层 (REST/SSE/WebSocket)        │
├─────────────────────────────────────────────────────────┤
│                    业务逻辑层 (Service)                   │
├─────────────────────────────────────────────────────────┤
│                    Agent 智能体层                        │
├─────────────────────────────────────────────────────────┤
│                    数据访问层 (DAO/Repository)            │
├─────────────────────────────────────────────────────────┤
│                    数据存储层 (MySQL/Redis/InfluxDB)      │
└─────────────────────────────────────────────────────────┘
```

## 核心组件架构

### 1. 物模型 (Thing Model)
物模型是平台的核心抽象，定义了物联网设备的功能、属性和事件：

- **产品 (Product)**: 设备的逻辑分组，提供隔离空间
- **物模型 (Thing Model)**: 定义设备功能模板
- **设备 (Device)**: 具体的物理或虚拟设备实例

### 2. Agent 智能体系统
- **大模型集成**: 支持 Qwen3、GLM、DeepSeek 等多种模型
- **工具调用**: 集成 MCP 协议，支持外部工具扩展
- **知识库**: RAG 检索增强生成，支持文档上传和智能检索
- **记忆系统**: 长期记忆管理和对话历史分析

### 3. 通信协议层
- **MQTT**: 基于 EMQX ExHook 的设备通信
- **WebSocket**: 实时双向通信
- **HTTP/HTTPS**: REST API 接口
- **MCP (Model Context Protocol)**: 模型上下文协议

### 4. 数据存储系统
- **MySQL**: 关系型数据存储 (用户、设备、物模型等)
- **Redis**: 缓存和会话管理
- **InfluxDB**: 时序数据存储 (设备数据、监控指标)
- **Chroma**: 向量数据库 (知识库检索)

## 微服务架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   认证服务        │    │   设备管理服务      │    │   Agent 服务      │
│   - 用户认证      │    │   - 物模型管理     │    │   - 智能对话       │
│   - 权限控制      │    │   - 设备接入       │    │   - 工具调用       │
└─────────────────┘    │   - MQTT 通信     │    │   - 知识库检索     │
                       └─────────────────┘    └─────────────────┘
                                │                       │
                                └───────────────────────┘
                                        │
                    ┌─────────────────────────────────────┐
                    │         数据存储层                    │
                    │   MySQL    Redis    InfluxDB       │
                    └─────────────────────────────────────┘
```

## 安全架构

- **认证机制**: Spring Security + JWT Token
- **设备认证**: EMQX MySQL 认证
- **API 访问控制**: 基于角色的权限控制 (RBAC)
- **数据加密**: HTTPS/TLS 传输加密
- **安全审计**: 操作日志记录

## 扩展能力

### MCP 协议集成
- **SSE 方式**: 支持服务器发送事件的 MCP 服务
- **WebSocket 方式**: 实时双向 MCP 通信
- **工具发现**: 自动发现和注册 MCP 工具

### 微信生态集成
- **微信小程序**: 设备控制和状态监控
- **微信服务号**: 消息推送和告警通知
- **OAuth2 认证**: 微信用户身份集成

## 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        负载均衡器                                │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                    IntelliConnect 应用服务器                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │   Web 模块   │ │  Agent 模块  │ │  MQTT 模块  │ │  微信模块    │ │
│  │             │ │             │ │             │ │             │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼────────┐ ┌────────────▼────────┐ ┌────────────▼────────┐
│   MySQL 集群    │ │     Redis 集群      │ │   InfluxDB 集群     │
│                │ │                     │ │                     │
└────────────────┘ └─────────────────────┘ └─────────────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                        ┌───────▼────────┐
                        │   EMQX 集群     │
                        │                │
                        └────────────────┘
```

## 技术栈

- **后端框架**: Spring Boot 2.7 + Spring Security
- **数据库**: MySQL 8.0+, Redis 6.0+, InfluxDB 2.x
- **消息中间件**: EMQX 5.x (MQTT)
- **向量数据库**: Chroma
- **前端框架**: Vue 3 (智控台)
- **通信协议**: MQTT, WebSocket, HTTP/HTTPS, MCP
- **部署方式**: Docker + Docker Compose